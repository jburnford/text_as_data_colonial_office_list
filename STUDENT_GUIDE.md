# Colonial Office List Extraction - Student Guide

## Quick Start: Use the Colab Notebook!

**No installation required!** Open the notebook in Google Colab:

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/YOUR_REPO/blob/main/Colonial_Office_List_Extraction.ipynb)

The notebook includes:
- Sample data
- Regex extraction code
- LLM prompt template
- Evaluation against gold standard

---

## Overview

This guide teaches you how to extract structured data from historical documents using an LLM (Gemini) to **generate Python code**. The key insight: instead of asking the AI to extract data directly, we ask it to write code containing the data. This gives us:

- **Reviewable output** - You can read the Python code and check for errors
- **Deterministic results** - Run the code, get the same JSON every time
- **Version control** - Commit the generated code to git

---

## Step 1: Open Google AI Studio

Go to: https://aistudio.google.com/

Sign in with your Google account (free).

Select **Gemini 2.0 Flash** as the model.

---

## Step 2: Copy the Prompt

Copy this entire prompt into AI Studio:

```
You are a code generator for historical data extraction. Given a Colonial Office List excerpt, generate a Python file that contains the extracted personnel data as a Python data structure.

## Your Task
Generate a complete, runnable Python file that:
1. Defines OFFICIALS as a list of dictionaries containing all extracted personnel
2. Includes a main() function that outputs JSON when run
3. Is self-contained with no external dependencies

## Output Format
Generate ONLY valid Python code. No markdown code fences, no explanations, just the raw .py file contents.

Use this exact structure:

"""
[COLONY] Colonial Office List [YEAR] - Extracted Data
Generated by Gemini via AI Studio
Source: Colonial Office List

This file contains extracted personnel data.
REVIEW THE OFFICIALS LIST FOR ACCURACY before running.
To generate JSON: python this_file.py
"""

COLONY = "[COLONY NAME]"
YEAR = [YEAR]

# Extracted officials - REVIEW THIS DATA FOR ACCURACY
OFFICIALS = [
    {
        "name": "F. Cardew",
        "canonical_name": "Cardew, F.",
        "given_names": "F.",
        "surname": "Cardew",
        "position": "Governor",
        "department": "Civil Establishment - [Colony]",
        "salary_min": 2000,
        "salary_max": 2000,
        "allowances": "500l. allowances",
        "honors": ["C.M.G."],
        "qualifications": [],
        "military_rank": "Colonel",
        "location": None,
    },
    # ... more officials following same structure ...
]

def get_extraction():
    """Return structured extraction result."""
    return {
        "colony": COLONY,
        "year": YEAR,
        "total_officials": len(OFFICIALS),
        "officials": OFFICIALS,
    }

def main():
    """Output extraction as JSON."""
    import json
    result = get_extraction()
    print(json.dumps(result, indent=2))

if __name__ == "__main__":
    main()

## Extraction Rules - FOLLOW THESE EXACTLY

1. Extract EVERY person mentioned in the source text
2. Handle "ditto" references:
   - "2nd ditto" after "Chief Clerk" = "2nd Clerk"
   - "3rd ditto" = "3rd Clerk", etc.
   - "Assistant ditto" after "Colonial Surgeon" = "Assistant Colonial Surgeon"

3. Parse salaries correctly:
   - "300l. to 400l." → salary_min=300, salary_max=400
   - "200l." → salary_min=200, salary_max=200
   - The "l." means pounds sterling

4. Expand ONLY these known abbreviations:
   - Wm. = William
   - Chas. = Charles
   - Thos. = Thomas
   - Jas. = James
   - Jno. = John
   - Robt. = Robert
   - Geo. = George

5. Do NOT expand single initials:
   - "C. George" stays "C. George" (NOT "Charles George")
   - "G. W. Cole" stays "G. W. Cole" (NOT "George W. Cole")
   - We don't know what single initials stand for

6. Honors (appear after name, uppercase with periods):
   - C.M.G., K.C.M.G., G.C.M.G., K.C.B., C.B., D.S.O.
   - Put in "honors" list

7. Qualifications (professional/academic credentials):
   - Medical: M.D., M.B., M.R.C.S., F.R.C.S., L.R.C.S., L.R.C.P.
   - Academic: B.A., M.A., LL.D., D.D.
   - Put in "qualifications" list

8. Military ranks (appear before name):
   - Colonel, Lt.-Col., Major, Captain, Capt.
   - Put in "military_rank" field

9. Extract location if mentioned in position:
   - "Dispenser, Waterloo" → position="Dispenser", location="Waterloo"
   - "Keeper, Lunatic Asylum, Kissy" → location="Kissy"

10. For vacant positions (salary but no name):
    - Set name, canonical_name, given_names, surname to None
    - Still extract the position and salary

11. Department names should include the colony suffix:
    - "Colonial Secretary's Department - Sierra Leone"

12. For multiple people on one line (semicolon-separated):
    - "A. Smith, 300l.; B. Jones, 250l." = TWO separate officials
    - Each gets their own entry in OFFICIALS list

## Source Text to Extract

[PASTE YOUR COLONIAL OFFICE LIST TEXT HERE]
```

---

## Step 3: Add Your Source Text

Replace `[PASTE YOUR COLONIAL OFFICE LIST TEXT HERE]` at the end of the prompt with your actual Colonial Office List text.

Example source text (Sierra Leone 1896, partial):

```
Civil Establishment.

Governor, Commander-in-Chief; and Vice-Admiral, Colonel F. Cardew, C.M.G., 2,000l. and 500l. allowances.

Colonial Secretary's Department.

Colonial Secretary, Lt.-Col. J. O. Gore, 710l. to 800l., and quarters.
Assistant Colonial Secretary, E. Faulkner, 300l. to 350l.
Chief Clerk, J. E. Dawson, 200l.
2nd ditto, E. W. Cole, 100l. to 120l.
3rd ditto, J. W. Paris, 100l.

Medical Department.

Colonial Surgeon, W. T. Prout, M.B., 50l., travelling allowance, 91l. 5s.
Assistant ditto, Wm. Renner, M.R.C.S., 300l. to 350l.; M. L. Jarrett, M.R.C.S., 250l.

Dispensers-
Waterloo, W. Z. Young, 50l., and quarters.
Hastings, M. Aubec, 36l., and quarters.
```

---

## Step 4: Run in AI Studio

Click **Run** (or press Ctrl+Enter).

Gemini will generate a complete Python file.

---

## Step 5: Save the Generated Code

1. Copy the entire output from AI Studio
2. Create a new file: `sierra_leone_1896_extraction.py`
3. Paste the code
4. Save the file

---

## Step 6: Review the Code

**This is the most important step!**

Open the generated Python file and review the `OFFICIALS` list:

- Are all people extracted?
- Are salaries correct?
- Are positions correct (especially "ditto" expansions)?
- Are names NOT over-expanded? (C. should stay C., not become Charles)
- Are qualifications in the right field?

Fix any errors you find by editing the Python file directly.

---

## Step 7: Run the Code

```bash
python sierra_leone_1896_extraction.py
```

This outputs JSON to the terminal. To save to a file:

```bash
python sierra_leone_1896_extraction.py > sierra_leone_1896.json
```

---

## Step 8: Load to Neo4j (Optional)

Once you have clean JSON, you can load it to Neo4j using the provided loading scripts.

---

## Why This Approach?

| Direct LLM Extraction | Code Generation |
|----------------------|-----------------|
| LLM outputs JSON directly | LLM outputs Python code |
| Hard to review | **Easy to review** |
| Errors are hidden | **Errors are visible** |
| Can't fix without re-running | **Edit code to fix** |
| Non-deterministic | **Deterministic** (run code = same output) |
| Can't version control | **Commit code to git** |

The key insight: **treat the LLM as a code generator, not a data extractor**. You review the code, then the code produces the data deterministically.

---

## Common Issues and Fixes

### Issue: Gemini outputs markdown code fences
If the output starts with \`\`\`python, remove the fences before saving.

### Issue: Over-expanded initials
If you see "Charles George" but the source says "C. George", edit the Python file to fix it.

### Issue: Missing officials
Check if semicolon-separated entries were split correctly. Add missing entries manually.

### Issue: Wrong department
Edit the department string in the Python file.

### Issue: Syntax error when running
Check for missing commas, brackets, or quotes in the OFFICIALS list.

---

## Exercise

1. Use the test data in `test_data/sierra_leone_1896_test.txt`
2. Extract using AI Studio with the prompt above
3. Save to `my_extraction.py`
4. Review and fix any errors
5. Run to generate JSON
6. Compare your output to `test_data/gold_standard.json`

Questions to answer:
- How many officials did you extract?
- Were the "ditto" positions expanded correctly?
- Were any initials incorrectly expanded?
- How long did the whole process take?

---

## Files in This Repository

| File | Purpose |
|------|---------|
| `STUDENT_GUIDE.md` | This guide |
| `test_data/sierra_leone_1896_test.txt` | Sample source text for practice |
| `test_data/gold_standard.json` | Correct extraction (42 officials) |
| `generated/sierra_leone_1896_extraction.py` | Example generated code |
| `extraction_codegen.py` | Automated version (requires API key) |

---

## Advanced: Batch Processing

For processing many documents, you can use `extraction_codegen.py` with a Google API key:

```bash
# Set up (one time)
echo "GOOGLE_API_KEY=..." > .env

# Run
python extraction_codegen.py path/to/source.txt
```

This automates the copy/paste workflow but requires an API key.
